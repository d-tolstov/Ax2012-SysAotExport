# Периодический экспорт объектов репозитария аксапты
## Зачем это всё
Самая главная цель этого функционала - сформировать историю изменения программного кода аксапты в файлах xpo с дискретностью в пару-тройку раз в сутки. Чтобы видеть как менялся тот или иной объект аксапты по датам. 
Если в разные ветки загружать разные приложения (дев, тест, прод) - можно путём сравнения веток видеть различия между приложениями.
## Как всё начиналось
Практически все современные разработчики используют в разработке системы контроля версий. С гитом, с комитами, с мерджами и т.д. Это позволяет не только упорядочить процесс переноса программного кода из одной среды в другую, но и получить историю изменения программного кода. В аксапте своя специфика среды разработки, использовать систему контроля версий теоретически можно, но мало кто это делает. Слишком много возни. А историю изменения программного кода в аксапте очень хотелось видеть. И решил я создать каталог с инициализированным гитом, со структурой подкаталогов как в репозитарии аксапты, выгружать объекты аксапты по отдельности в этот каталог и после каждой выгрузки делать комит. Чтобы комит фиксировал изменения после предыдущей выгрузки. Да, этот способ не позволяет увидеть во сколько именно было сделано изменение и кто именно его сделал. Но в реальной работе обычно это и не требуется. Главное - просто увидеть что в определённый день в указанном объекте что-то изменилось. Остальное - дело техники.
## Особенности функционала
* Экспортируются все объекты кроме джобов
* Выбираются только те объекты, в которых присутствуют слои cus и usr
* Каждый объект экспортируется в отдельный файл xpo (используется штатный механизм экспорта объекта аксапты в xpo-файл)
* Если во время очередного экспорта обнаружилось, что в каталоге присутствует файл, для которого в данный момент нет объекта в аксапте (например, в прошлый раз экспортировалась таблица, которую после удалили), то этот файл будет помещён в каталог DELETED. Внутри каталога DELETED структура каталогов совпадает со структурой каталогов в корне.
* Наряду с объектами аксапты происходит выгрузка в файлы исходного кода объектов БД, создаваемых не штатными средствами аксапты (хранимые процедуры, триггеры, функции)
* Экспорт репозитария инициируется командным файлом на выделенном сервере с установленным клиентом аксапты и гитом. Командный файл запускается по расписанию планировщиком задач.
## Реализация
### Класс SysAotExport_CDT
Основа функционала - класс экспорта объектов репозитария. Обычно он запускается с помощью скрипта, но при желании (например, первоначально) его можно запускать вручную.
<img src="pictures\SysAotExport_Dialog.png" alt="схема">
#### Каталог
Каталог, в который будут экспортированы объекты
#### Удалить файлы для ненайденных объектов в АОТ
Галочку необходимо включать если планируется перемещать в папку DELETED ранее экспортированные, но удаленные в данный момент объекты.
#### Измененные дата и время
Экспорт будет выполняться только для тех объектов, которые изменены\созданы после указанной даты и времени. Если вы первый раз экспортируете объекты и хотите выгрузить весь АОТ - оставьте это поле пустым. Например, во время автоматического экспорта в целях оптимизации это поле всегда устанавливается в значение “текущая дата - 10 дней“.
### Командный файл запуска экспорта
```
cd C:\Users\username\Documents\AxAOTExport\AOT
set AutoRun=%~dp0AOT_Export.xml
 
powershell %~dp0git_checkout_dev.ps1
set axc="\\file-server\axc\dev.axc"
"C:\Program Files (x86)\Microsoft Dynamics AX\60\Client\Bin\Ax32.exe" %axc% -startupcmd=autorun_%AutoRun%
powershell %~dp0git_commit.ps1
 
powershell %~dp0git_checkout_test.ps1
set axc="\\file-server\axc\test.axc"
"C:\Program Files (x86)\Microsoft Dynamics AX\60\Client\Bin\Ax32.exe" %axc% -startupcmd=autorun_%AutoRun%
powershell %~dp0git_commit.ps1
 
powershell %~dp0git_checkout_prod.ps1
set axc="\\file-server\axc\prod.axc"
"C:\Program Files (x86)\Microsoft Dynamics AX\60\Client\Bin\Ax32.exe" %axc% -startupcmd=autorun_%AutoRun%
powershell %~dp0git_commit.ps1
 
timeout 10
```
В командном файле поочередно происходят следующие вещи :
* определяется каталог для экспорта (он нужен для гита)
* выполняется чекаут в необходимую ветку гита (если в каталоге в разных ветках хранится несколько приложений)
* запускается клиент аксапты, которому с помощью startupcmd передаётся команда запуска класса экспорта
* вызывается git commit и git push
### Файл AOT_Export.xml для команды autorun
```
<AxaptaAutoRun exitWhenDone="true" version="6.0" logFile="C:\AxaptaAutorun.log">
    <!--
        Каталог в parameters нужно передавать в следующем виде : 'E:\\vcs\\Ax2012'
    -->
    <Run type="class" name="SysAOTExport_CDT" method="export" parameters="'C:\\Users\\username\\Documents\\AxAOTExport\\AOT'" />
</AxaptaAutoRun>
```
### Файл git_checkout_dev.ps1 для смены ветки в гите
```
Set-Location C:\Users\username\Documents\AxAOTExport\AOT
git checkout -- .
git checkout dev
```
Файлы для остальных веток делаются по аналогии.
### Файл git_commit.ps1 для вызова комита в гите
```
Set-Location C:\Users\username\Documents\AxAOTExport\AOT
git add --all
$commitmessage = [System.DateTime]::Now.ToString('yyyy.MM.dd HH:mm')
$commitmessage
git commit -m $commitmessage
git push
```
### Пользователь для запуска экспорта
Для экспорта должен быть выбран отдельный пользователь. В скриптах его доменное имя указано как "username". Так как мы применяем функционал startupcmd и внутри файла xml указываем Run type="class" - этот пользователь должен быть админом в аксапте.
## Зависимости от других репозиториев :
- [SysFile](https://github.com/d-tolstov/Ax2009-SysFile)
